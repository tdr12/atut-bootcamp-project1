name: Build & Deploy to Scaleway
on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Login to Scaleway Container Registry
      uses: docker/login-action@v3
      with:
        username: nologin
        password: ${{ secrets.SCALEWAY_API_KEY }}
        registry: ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}
    - name: Build the Docker image
      run: docker build . -t ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/delano-app-test
    - name: Push the Docker Image
      run: docker push ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/delano-app-test
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to instance
        uses: appleboy/ssh-action@master@v0.1.6 #philibea/scaleway-containers-deploy@v1.0.5
        with:
          host: ${{ secrets.HOST }}           # Adresse du serveur SSH
          username: ${{ secrets.SSH_USER }}   # Nom d’utilisateur pour se connecter au serveur SSH
          key: ${{ secrets.SSH_PRIVATE_KEY }} # Clé privée SSH pour l’authentification
          script: |
            # Récupérer la dernière version de l'image depuis le registre
            docker pull ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/delano-app-test || exit 1
                
            # Arrêter et supprimer le conteneur existant (si nécessaire)
            # docker stop delano-app-test || true
            # docker rm delano-app-test || true
                
            # Lancer le nouveau conteneur
            docker run -d --name delano-app-test -p 8033:8033 ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/delano-app-test
  # deploy:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Deploy to instance
  #       uses: appleboy/ssh-action@master
  #       with:
  #         host: ${{ secrets.SSH_HOST }}
  #         username: ${{ secrets.SSH_USER }}
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         script: |
  #           # Récupérer la dernière version de l'image depuis le registre
  #           docker pull ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/jcredo:${{ github.sha }} || exit 1
            
  #           # Arrêter et supprimer le conteneur existant (si nécessaire)
  #           docker stop jcredo || true
  #           docker rm jcredo || true
            
  #           # Lancer le nouveau conteneur
  #           docker run -d --name jcredo -p 8020:8020 ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/jcredo:${{ github.sha }}
  # deploy:
  # needs: build
  # runs-on: ubuntu-latest
  # steps:
  #   - name: Deploy to instance
  #     uses: appleboy/ssh-action@master
  #     with:
  #       host: ${{ secrets.HOST }} # Adreese ip du serveur
  #     username: ${{ secrets.SSH_USER }} # l'utilisateur au niveau du serveur
  #     key: ${{ secrets.SSH_PRIVATE_KEY }} # Cle privee
  #     script: |
  #       # Récupérer la dernière version de l'image depuis le registre
  #       docker pull ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/delano-app-test:v0 || exit 1
            
  #       #Arrêter et supprimer le conteneur existant (si nécessaire)
  #       docker stop delano-app-test || true
  #       docker rm delano-app-test || true
            
  #       # Lancer le nouveau conteneur
  #       docker run -d --name delano-app-test -p 8033:8033 ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/delano-app-test:v0


# deploy:
#   needs: build
#   runs-on: ubuntu-latest
#   name: Deploy on Scaleway Containers
#   steps:
#     - name: Checkout
#       uses: actions/checkout@v4
#     - name: Scaleway Container Deploy action
#       id: deploy
#       uses: appleboy/ssh-action@master # philibea/scaleway-containers-deploy@v1.0.5
#       with:
#         type: deploy
#         host: ${{ secrets.HOST }}
#         scw_access_key:  ${{ secrets.ACCESS_KEY }}
#         scw_secret_key: ${{ secrets.SECRET_KEY }}
#         scw_containers_namespace_id: ${{ secrets.CONTAINERS_NAMESPACE_ID }}
#         scw_registry: docker pull rg.fr-par.scw.cloud/atut-group-2/delano-app-test:latest
#           #docker pull ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/delano-app-test:latest
  